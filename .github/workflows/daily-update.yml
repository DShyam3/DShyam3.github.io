name: Daily MediaBoard Update

on:
  schedule:
    # Run daily at 6:00 AM UTC (adjust timezone as needed)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-mediaboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run MediaBoard update
      id: update
      run: |
        echo "start_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        npm run update-mediaboard:daily
        echo "end_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes (if any)
      if: steps.changes.outputs.no_changes == 'false'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "Daily MediaBoard update - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        git push
        
    - name: Send success email notification
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "✅ MediaBoard Daily Update Completed"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.SMTP_FROM }}
        body: |
          <h2>MediaBoard Daily Update Completed Successfully</h2>
          <p><strong>Update Time:</strong> ${{ steps.update.outputs.start_time }}</p>
          <p><strong>Completion Time:</strong> ${{ steps.update.outputs.end_time }}</p>
          <p><strong>Changes Made:</strong> ${{ steps.changes.outputs.no_changes == 'false' && 'Yes' || 'No' }}</p>
          <p><strong>Repository:</strong> ${{ github.repository }}</strong></p>
          <p><strong>Workflow:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>
          <hr>
          <p><em>This is an automated notification from your MediaBoard update system.</em></p>
        html: true
        
    - name: Send failure email notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "❌ MediaBoard Daily Update Failed"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.SMTP_FROM }}
        body: |
          <h2>MediaBoard Daily Update Failed</h2>
          <p><strong>Failure Time:</strong> $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
          <p><strong>Repository:</strong> ${{ github.repository }}</strong></p>
          <p><strong>Workflow:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>
          <hr>
          <p><em>Please check the workflow logs for more details about the failure.</em></p>
        html: true
